# RedHat Ansible Molecule test framework

## Summary

This is a framework for the automated testing of Ansible roles against multiple platforms.

If you just want to use Ansible to deploy netdata then you do not need to use this. Instead, use the Ansible roles in the parent directory of the repository.


## Prerequisites

Requires:
- Ansible
- Docker
- Molecule (see [Molecule documentation](https://ansible.readthedocs.io/projects/molecule/installation/) for full requirements)

Tested with Ansible v2.15.1 and Docker v24.0.4.

# Ansible roles tested

- `install_netdata_repository`

# Tested on
`Centos 7, Rocky 8, Oracle Linux 8, Fedora 35`

`Debian 10, Debian 11, Ubuntu 18, Ubuntu 20, Ubuntu22`

## Usage
> molecule test

Will do the following:

- Creates virtual environments. (equivalent to running just: `molecule create`)
- Runs Ansible Playbooks against environments. (equivalent to running just: `molecule converge`)
- Destroys virtual environments. (equivalent to running just: `molecule destroy`)

Run all Molecule commands from the root directory of the repository and not from the `molecule` folder or within the `Roles` folder.*

If you are new to Molecule, or even if you have some new untested changes to test, it's strongly recommended to run only part of the test cycle by first invoking:
> molecule create

and then

> molecule converge

That way, if anything fails you can adjust your Ansible code and then simply re-run molecule converge.

## Molecule implementation structure

The Molecule directory has the structure as follows:

```bash
.
├── common
│   ├── Dockerfile_debian10.j2
│   ├── Dockerfile_debian11.j2
│   ├── Dockerfile_ubuntu1804.j2
│   ├── Dockerfile_ubuntu2004.j2
│   └── Dockerfile_ubuntu2204.j2
├── default
│   ├── converge.yml
│   ├── molecule.yml
│   └── verify.yml
└── README.md

```

# Dockerfiles
These are custom Dockerfiles which contain the required tools for deploying the Ansible roles you want to test.

# Default > converge
This file imports the Ansible roles that you wish to test.

# Default > molecule
This file contains a list of platforms/images to be tested against along with other settings such as which driver to use.


# Notes

1. If you run Molecule from the wrong directory you will get an error such as:
> CRITICAL 'molecule/default/molecule.yml' glob failed.  Exiting.
2. Linting Molecule can be a little tricky and so it's recommended to exclude the `molecule` folder from your main Ansible linting.
    * You can add your Molecule specific lint-settings via the `molecule.yml` file's `verifier` section, etc.
3. It is expected that the custom Dockerfiles will be deprecated in the very near future in favour of images built to the same recipe but generated by the Netdata build-system and made available in Github, etc.



## To do

Currently, this Molecule framework has only been fully tested against the role `install_netdata_repository`.

Additonal roles will be tested in short-order.
